/**
 * Image Store - jQuery touch plugin
 *
 * @file touch.jquery.js
 * @package Image Store
 * @author  Martin Angelov / Hafid Trujillo
 * @copyright 20010-2013
 * @filesource  wp-content/plugins/image-store/_js/touch.jquery.jquery.js
 * @since 3.2.1
 */

(function(e){var t=e('<div id="touch-overlay">'),n=e('<div id="touch-slider">'),r=e('<a id="touch-prev"></a>'),i=e('<a id="touch-next"></a>'),s=e('<a class="touch-close">x</a>'),o=0,u=false;e.fn.imstouch=function(a){function m(e){setTimeout(function(){x(e)},1e3)}function g(t,n){e.event.trigger(t,l);if(n){n.call(e("#ims-slide-"+l),l)}}function y(t){return parseInt(e("#touch-slider .ims-slide").index(e("#ims-slide-"+t)))}function b(t){return parseInt(e(t).attr("class").replace(/^(.+)?(ims-touch-)([0-9]{1,})(.+)?$/g,"$3"))}function w(e){n.css("left",-e*100+"%")}function E(n,s){url=e(s.target).parent().attr("href");if(!v.href&&url!=""&&url.search(/\.(png|jpg|jpeg|gif|php)/i)==-1){window.location=url;return}if(u){return false}if(v.href){e(v.href).find(".touch-close").bind("click",N)}t.show();setTimeout(function(){t.addClass("visible")},100);e(document).bind("keydown",function(e){if(e.keyCode===37){e.preventDefault();r.click()}else if(e.keyCode===39){e.preventDefault();i.click()}else if(e.keyCode==27)N()});w(n);u=true;g("touch_open",v.onOpen)}function S(t,n){var r=e('<img class="touch-shadow">').bind("load",function(){n.call(r);g("touch_image_loaded")});if(!("ontouchstart"in window))r.bind("click",C);r.attr("src",t)}function x(t){$slide=e(".ims-touch-"+t);$selected=$slide.parent().hasClass("ims-selected");S($slide.attr("href"),function(){$this=e(".ims-touch-"+t);$frame=e("#ims-slide-"+t);$meta=e('<span class="img-metadata" ></span>');if($this.next(".img-metadata")[0])$meta=$this.next(".img-metadata").clone();if(title=$this.parents(".ims-img").find(".img-name").html())$meta.prepend('<span class="image-title">'+title+"</span>");$frame.removeClass("ims-selected").html(this).append($meta);if($selected)$frame.addClass("ims-selected")})}function T(t){if(!e("#ims-slide-"+t)[0]){return false}if(v.href){if(!e(v.href).hasClass("touch-shadow"))e(v.href).addClass("touch-shadow");if(v.iframe&&e(".ims-touch-"+t).attr("href")){s.show();$iframe=e('<iframe class="touch-iframe" src="'+e(".ims-touch-"+t).attr("href")+'"></iframe>');e("#ims-slide-"+t).html($iframe);$iframe.bind("load",function(){e(this).unbind("load");e(this).animate({width:"90%",height:"85%"})})}else{e("#ims-slide-"+t).html(e(v.href).css({display:"inline-block"}))}return true}x(t);if(!v.href){if(c>0)r.show();if(c<d.length-1)i.show();s.show()}}function N(){if(!u){return false}g("touch_before_close");t.hide().removeClass("visible");u=false;if(v.href)e(v.href).hide().appendTo("body");else d.empty();r.hide();i.hide();s.hide();e(document).unbind("keydown");tems=h;e(window).scrollTop(e(".ims-touch-"+l).offset().top-300);g("touch_close",v.onClose)}function C(){if(r.is(":hidden"))r.show();if(c+1<d.length){l++;c++;if(c>=d.length-1)i.hide();w(y(l));m(l+1);g("touch_next")}else{n.addClass("rightSpring");setTimeout(function(){n.removeClass("rightSpring")},500)}}function k(){if(i.is(":hidden"))i.show();if(c>0){l--;c--;if(c<=0)r.hide();w(y(l));m(l-1);g("touch_previous")}else{n.addClass("leftSpring");setTimeout(function(){n.removeClass("leftSpring")},500)}}var f="",l=0,c=0,h=this,p=h,d=e([]);var v=e.extend({href:false,iframe:false,onOpen:false,onClose:false},a);if(!e("#touch-overlay")[0]){t.hide().appendTo("body");n.appendTo(t)}closeOverlay=function(t){if(e(t.target).attr("class")!="ims-slide")return;N()};p.each(function(){e(this).addClass("ims-touch-"+o);f+='<div id="ims-slide-'+o+'" class="ims-slide"></div>';o++});n.append(d=e(f).bind("click",closeOverlay));e("#touch-overlay").delegate(" .ims-slide img","touchstart",function(e){var t=e.originalEvent,r=t.changedTouches[0].pageX;n.bind("touchmove",function(e){e.preventDefault();t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];if(t.pageX-r>10)k();else if(t.pageX-r<-10)C();n.unbind("touchmove")});return false}).bind("touchend",function(){n.unbind("touchmove")});p.bind("click",function(n){n.preventDefault();l=b(this);offset=y(l);c=p.index(e(".ims-touch-"+l));E(offset,n);T(l);if(!v.href){if(c<p.length)m(l+1);if(c>0)m(l-1)}if(!t.find(".touch-close")[0]){s.bind("click",N);t.prepend(s)}});if(!v.href){t.append(r).append(i);r.bind("click",function(e){e.preventDefault();k()});i.bind("click",function(e){e.preventDefault();C()});r.hide();i.hide()}}})(jQuery)